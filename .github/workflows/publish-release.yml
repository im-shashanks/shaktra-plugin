name: Publish Release Branch

on:
  push:
    branches: [main]
    paths:
      - 'dist/shaktra/**'
      - '.claude-plugin/marketplace.json'
      - 'Resources/**'

permissions:
  contents: write

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.RELEASE_PAT }}

      - name: Build release tree
        run: |
          set -euo pipefail
          BUILD="release-build"
          rm -rf "$BUILD"
          mkdir "$BUILD"

          # Copy entire dist/ structure as-is (preserves plugin organization)
          cp -r dist/* "$BUILD/"

          # Copy workflow diagram for README
          mkdir -p "$BUILD/Resources"
          cp Resources/workflow.drawio.png "$BUILD/Resources/"

          # Remove __pycache__ if copied
          find "$BUILD" -type d -name __pycache__ -exec rm -rf {} + 2>/dev/null || true

          # Copy marketplace.json and transform sources: "./dist/shaktra" -> "./shaktra" for release
          mkdir -p "$BUILD/.claude-plugin"
          python3 -c "
          import json, pathlib
          p = pathlib.Path('.claude-plugin/marketplace.json')
          data = json.loads(p.read_text())
          for plugin in data.get('plugins', []):
              if plugin.get('source') == './dist/shaktra':
                  plugin['source'] = './shaktra'
          (pathlib.Path('$BUILD') / '.claude-plugin' / 'marketplace.json').write_text(
              json.dumps(data, indent=2) + '\n')
          "

          # Copy marketplace README for release branch root
          cp README-marketplace.md "$BUILD/README.md"

          # Copy CHANGELOG for user visibility
          cp CHANGELOG.md "$BUILD/CHANGELOG.md"

          # Minimal .gitignore
          cat > "$BUILD/.gitignore" << 'GITIGNORE'
          .DS_Store
          __pycache__/
          *.py[codz]
          .claude/
          .local/
          .venv/
          GITIGNORE

      - name: Validate release structure
        run: |
          set -euo pipefail
          BUILD="release-build"
          errors=0

          # marketplace.json exists at root
          if [ ! -f "$BUILD/.claude-plugin/marketplace.json" ]; then
            echo "FAIL: marketplace.json missing"
            errors=$((errors + 1))
          fi

          # Validate each plugin listed in marketplace.json
          plugin_count=$(python3 -c "
          import json
          data = json.load(open('$BUILD/.claude-plugin/marketplace.json'))
          print(len(data.get('plugins', [])))
          ")
          echo "Found $plugin_count plugin(s)"

          # Check shaktra plugin structure
          if [ ! -f "$BUILD/shaktra/.claude-plugin/plugin.json" ]; then
            echo "FAIL: shaktra/plugin.json missing"
            errors=$((errors + 1))
          fi

          # Count agents in shaktra (12 expected)
          agent_count=$(ls "$BUILD/shaktra/agents/"*.md 2>/dev/null | wc -l | tr -d ' ')
          if [ "$agent_count" -ne 12 ]; then
            echo "FAIL: expected 12 agents in shaktra, found $agent_count"
            errors=$((errors + 1))
          fi

          # Count skills in shaktra (16 expected)
          skill_count=$(ls -d "$BUILD/shaktra/skills/"*/ 2>/dev/null | wc -l | tr -d ' ')
          if [ "$skill_count" -ne 16 ]; then
            echo "FAIL: expected 16 skills in shaktra, found $skill_count"
            errors=$((errors + 1))
          fi

          # Count scripts in shaktra (5 expected)
          script_count=$(ls "$BUILD/shaktra/scripts/"*.py 2>/dev/null | wc -l | tr -d ' ')
          if [ "$script_count" -ne 5 ]; then
            echo "FAIL: expected 5 scripts in shaktra, found $script_count"
            errors=$((errors + 1))
          fi

          # hooks.json present in shaktra
          if [ ! -f "$BUILD/shaktra/hooks/hooks.json" ]; then
            echo "FAIL: shaktra/hooks/hooks.json missing"
            errors=$((errors + 1))
          fi

          # No dev-only files
          for devfile in CLAUDE.md docs .claude .local .venv dist; do
            if [ -e "$BUILD/$devfile" ]; then
              echo "FAIL: dev-only '$devfile' found in release build"
              errors=$((errors + 1))
            fi
          done

          if [ "$errors" -gt 0 ]; then
            echo "Validation failed with $errors error(s)"
            exit 1
          fi

          echo "Validation passed"

      - name: Push to release branch
        run: |
          set -euo pipefail
          BUILD="release-build"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Create orphan release branch or check it out
          if git rev-parse --verify origin/release >/dev/null 2>&1; then
            git checkout release
            # Remove all tracked files
            git rm -rf . >/dev/null 2>&1 || true
          else
            git checkout --orphan release
            git rm -rf . >/dev/null 2>&1 || true
          fi

          # Copy build contents
          cp -r "$BUILD"/. .
          rm -rf "$BUILD"

          # Stage and commit
          git add -A
          if git diff --cached --quiet; then
            echo "No changes to release branch"
          else
            MAIN_SHA=$(git rev-parse main)
            git commit -m "Release from main@${MAIN_SHA:0:7}"
          fi

          git push origin release
